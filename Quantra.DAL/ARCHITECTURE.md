# Quantra Data Layer Architecture

## Architecture Diagram

```
???????????????????????????????????????????????????????????????????????
?     Application Layer      ?
?  (ViewModels, Commands, Event Handlers, Business Logic)  ?
???????????????????????????????????????????????????????????????????????
    ?
      ?
???????????????????????????????????????????????????????????????????????
?      Service Layer            ?
?  ???????????????????  ????????????????????  ????????????????????  ?
?  ? ModernLogging   ?  ? ModernStock      ?  ? ModernTrading ?  ?
?  ? Service  ?  ? Service          ?  ? RuleService      ?  ?
?  ???????????????????  ????????????????????  ????????????????????  ?
?           ?  ?           ?             ?
???????????????????????????????????????????????????????????????????????
            ?         ?   ?
            ?        ?         ?
???????????????????????????????????????????????????????????????????????
?     Repository Layer ?
?  ????????????????  ???????????????????  ????????????????????????  ?
?  ? ILogRepository ?  ? IStockSymbol    ?  ? ITradingRule      ?  ?
?  ?       ?  ? Repository  ?  ? Repository       ?  ?
?  ????????????????  ???????????????????  ???????????????????????  ?
?   ?             ?        ?    ?
?  ??????????????????????????????????????????????????????????????  ?
?  ?   Generic Repository<T>  ?  ?
?  ? (Common CRUD Operations)             ?  ?
?  ??????????????????????????????????????????????????????????????  ?
?????????????????????????????????????????????????????????????????????
   ?
      ?
???????????????????????????????????????????????????????????????????????
?       Entity Framework Core Layer   ?
?   (QuantraDbContext)              ?
?  ????????????  ????????????  ????????????  ?????????????
?  ? DbSet    ?  ? DbSet    ?  ? DbSet ?  ? DbSet    ?  ...     ?
?  ? <Logs>   ?  ? <Stocks> ?  ? <Orders> ?  ? <Rules>  ?      ?
?  ????????????  ????????????  ????????????  ????????????        ?
?       ?           ?     ?             ?     ?
?   ????????????????????????????????????????????         ?
?          ?         ?
?  ?            ?
?  ??????????????????????????????????????????????????????????        ?
?  ?         Change Tracker & Query Provider   ?        ?
?  ?  (LINQ, Connection Pooling, Caching, Migrations)      ?  ?
?  ??????????????????????????????????????????????????????????        ?
???????????????????????????????????????????????????????????????????????
         ?
    ?
???????????????????????????????????????????????????????????????????????
?         Database Provider Layer               ?
?   (Microsoft.EntityFrameworkCore.Sqlite)   ?
???????????????????????????????????????????????????????????????????????
        ?
          ?
???????????????????????????????????????????????????????????????????????
?                  SQLite Database       ?
?        (Quantra.db)         ?
?           WAL Mode Enabled                ?
???????????????????????????????????????????????????????????????????????
```

## Data Flow

### Read Operation (Query)
```
ViewModel/Service
       ?
       ?
   Repository.GetAllAsync()
       ?
       ?
   DbContext.Logs.ToListAsync()
       ?
       ?
   EF Core Query Provider
       ?
    ?
   SQL Generation
       ?
       ?
   SQLite Database
       ?
       ?
   ResultSet ? Entity Tracking
       ?
    ?
   Return List<LogEntry>
```

### Write Operation (Insert/Update)
```
ViewModel/Service
       ?
       ?
   Repository.AddAsync(entity)
       ?
       ?
   DbContext.Logs.Add(entity)
       ?
       ?
   Change Tracker (Marks as Added)
       ?
       ?
   SaveChangesAsync()
       ?
       ?
   Generate INSERT SQL
       ?
    ?
   SQLite Database
       ?
       ?
   Return Affected Rows
```

## Component Responsibilities

### Application Layer
- **ViewModels**: UI state and user interaction
- **Commands**: User actions
- **Business Logic**: Domain-specific rules

### Service Layer
- **ModernLoggingService**: Logging operations
- **ModernStockService**: Stock data operations
- **ModernTradingRuleService**: Trading rule management
- **Custom Services**: Domain-specific logic

### Repository Layer
- **IRepository<T>**: Generic CRUD operations
- **Specialized Repos**: Domain-specific queries
- **Abstraction**: Hides EF Core from business logic

### DbContext Layer
- **QuantraDbContext**: Central database access
- **DbSets**: Entity collections
- **Configurations**: Entity mappings
- **Change Tracking**: Automatic state management

### Entity Layer
- **POCOs**: Plain old CLR objects
- **Data Annotations**: Validation rules
- **Navigation Properties**: Relationships

## Dependency Injection Flow

```
Startup (App.xaml.cs)
       ?
       ?
services.AddQuantraDatabase()
       ?
       ??? Register QuantraDbContext (Scoped)
       ?
       ??? Register ILogRepository ? LogRepository (Scoped)
    ?
   ??? Register IStockSymbolRepository ? StockSymbolRepository (Scoped)
       ?
       ??? Register ITradingRuleRepository ? TradingRuleRepository (Scoped)
       ?
       ??? Register IRepository<T> ? Repository<T> (Scoped)
       ?
       ?
ServiceProvider.BuildServiceProvider()
       ?
       ?
serviceProvider.InitializeQuantraDatabase()
       ?
       ?
Application Ready with DI Container
```

## Usage in ViewModel

```csharp
public class StockViewModel
{
    private readonly IStockSymbolRepository _stockRepo;
    private readonly ModernLoggingService _logger;

    // Constructor Injection
  public StockViewModel(
   IStockSymbolRepository stockRepo,
    ModernLoggingService logger)
    {
        _stockRepo = stockRepo;
   _logger = logger;
    }

 public async Task LoadStocksAsync()
    {
        await _logger.LogAsync("Info", "Loading stocks");
        
  // Use repository
        var stocks = await _stockRepo.GetAllAsync();
 
        // Or use LINQ with DbContext
        var techStocks = await _stockRepo.FindAsync(
          s => s.Sector == "Technology");
    }
}
```

## Entity Relationships

```
StockPredictionEntity (1)
       ?
       ? 1:N
?
PredictionIndicatorEntity (N)

(Composite Key: PredictionId + IndicatorName)
(Foreign Key: PredictionId ? StockPredictionEntity.Id)
(Cascade Delete: If prediction deleted, indicators are deleted)
```

## Migration Process

```
Developer
    ?
    ?
Make Entity Changes
    ?
    ?
dotnet ef migrations add MigrationName
    ?
    ?
EF Core Analyzes Model
    ?
    ?
Generate Migration File (Up/Down methods)
    ?
    ?
dotnet ef database update
    ?
    ?
EF Core Applies SQL Changes
    ?
    ?
Database Schema Updated
    ?
    ?
__EFMigrationsHistory Table Updated
```

## Performance Optimizations

```
Query Pipeline:

LINQ Expression
    ?
    ?
Expression Tree Analysis
    ?
    ?
Query Caching (Compiled Query)
    ?
    ?
SQL Generation
    ?
    ?
Parameter Binding
    ?
    ?
Connection Pool
    ?
    ?
SQLite Execution (WAL Mode)
    ?
    ?
Result Materialization
    ?
    ?
Change Tracking (if not AsNoTracking)
    ?
    ?
Return Results
```

## Testing Strategy

```
???????????????????????????????????????????
?         Unit Tests      ?
?  (In-Memory Database)         ?
?   ?
?  - Repository Tests?
?  - Service Tests          ?
?  - Fast Execution      ?
?  - No Side Effects  ?
???????????????????????????????????????????
?
             ?
???????????????????????????????????????????
? Integration Tests    ?
?  (Test SQLite Database)   ?
?        ?
?  - Full Stack Tests        ?
?  - DbContext Tests   ?
?  - Migration Tests         ?
?  - Slower but Realistic         ?
???????????????????????????????????????????
 ?
   ?
???????????????????????????????????????????
?    End-to-End Tests        ?
?  (Production Database)           ?
?             ?
?  - Smoke Tests       ?
?  - Performance Tests              ?
?  - Load Tests ?
???????????????????????????????????????????
```

## Comparison: Old vs New

### Old (DatabaseMonolith)
```
ViewModel ? DatabaseMonolith ? Raw SQL ? SQLite
           (Static Methods)   (Dapper)
```
**Issues:**
- ? Tight coupling
- ? Hard to test
- ? No type safety
- ? Manual SQL
- ? No change tracking
- ? No migrations

### New (EF Core)
```
ViewModel ? Service ? Repository ? DbContext ? EF Core ? SQLite
          (DI)      (Interface)   (DbSet<T>)  (LINQ)
```
**Benefits:**
- ? Loose coupling
- ? Easy to test
- ? Type safe
- ? LINQ queries
- ? Change tracking
- ? Migrations
- ? Performance optimizations

## File Organization

```
Quantra.DAL/
??? Data/
?   ??? QuantraDbContext.cs
?   ??? QuantraDbContextExtensions.cs
?   ??? README.md
?   ?
?   ??? Entities/
?   ?   ??? ConfigurationEntities.cs
?   ?   ??? StockEntities.cs
?   ?   ??? TradingEntities.cs
?   ?   ??? PredictionEntities.cs
?   ?   ??? AnalystEntities.cs
?   ?
?   ??? Configurations/
?   ?   ??? EntityConfigurations.cs
? ?
?   ??? Repositories/
?       ??? GenericRepository.cs
?
??? Services/
?   ??? ModernDatabaseServices.cs
?
??? DatabaseMonolith.cs (Backward compatibility)
?
??? MIGRATION_GUIDE.md
??? MIGRATION_SUMMARY.md
??? MIGRATION_CHECKLIST.md
```

---

This architecture provides:
- ?? **Separation of Concerns**
- ?? **Type Safety**
- ?? **Testability**
- ?? **Performance**
- ?? **Scalability**
- ?? **Maintainability**
