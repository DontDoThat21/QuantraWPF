<UserControl x:Class="Quantra.Controls.TechnicalIndicatorVisualizationControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Quantra.Controls"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="600"
             Background="#23233A">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Quantra;component/Styles/EnhancedStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header with stock info and timeframe selectors -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5">
            <TextBlock x:Name="SymbolTextBlock" Text="Symbol: AAPL" 
                       Style="{StaticResource EnhancedTextBlockStyle}" FontWeight="Bold" Margin="0,0,20,0"/>
            <TextBlock x:Name="PriceTextBlock" Text="Price: $185.92" 
                       Style="{StaticResource EnhancedSmallTextBlockStyle}" Margin="0,0,20,0"/>
            <TextBlock x:Name="ChangeTextBlock" Text="+1.23 (+0.67%)" 
                       Style="{StaticResource EnhancedSmallTextBlockStyle}" Foreground="#4CAF50" Margin="0,0,20,0"/>
            <TextBlock x:Name="Rsi" Text="RSI:" 
                Style="{StaticResource EnhancedSmallTextBlockStyle}"/>
        </StackPanel>

        <!-- Time Range Selector -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10,0,10,5">
            <Button x:Name="TimeRange1D" Content="1D" Tag="1day" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>
            <Button x:Name="TimeRange5D" Content="5D" Tag="5day" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>
            <Button x:Name="TimeRange1M" Content="1M" Tag="1mo" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>
            <Button x:Name="TimeRange6M" Content="6M" Tag="6mo" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>
            <Button x:Name="TimeRange1Y" Content="1Y" Tag="1y" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>
            <Button x:Name="TimeRange5Y" Content="5Y" Tag="5y" Width="40" Height="30" Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,5,0" Click="TimeRangeButton_Click"/>

            <!-- Spacer -->
            <Border Width="40"/>

            <!-- Show/Hide Legend -->
            <CheckBox x:Name="ToggleLegend" Content="Legend" IsChecked="True" 
                      Style="{StaticResource EnhancedCheckBoxStyle}" Margin="0,0,15,0"
                      Checked="ToggleLegend_Checked" Unchecked="ToggleLegend_Unchecked"/>

            <!-- Show/Hide Crosshair -->
            <CheckBox x:Name="ToggleCrosshair" Content="Crosshair" IsChecked="True" 
                      Style="{StaticResource EnhancedCheckBoxStyle}" Margin="0,0,15,0"
                      Checked="ToggleCrosshair_Checked" Unchecked="ToggleCrosshair_Unchecked"/>

            <!-- Synchronize Tooltips -->
            <CheckBox x:Name="SyncTooltips" Content="Sync Tooltips" IsChecked="True" 
                      Style="{StaticResource EnhancedCheckBoxStyle}" Margin="0,0,15,0"/>
        </StackPanel>

        <!-- Multi-panel Chart Container -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid x:Name="ChartsGrid">
                <Grid.RowDefinitions>
                    <!-- Price Chart (always present) -->
                    <RowDefinition Height="3*" MinHeight="200"/>
                    <!-- Volume Chart -->
                    <RowDefinition Height="1*" MinHeight="100"/>
                    <!-- Oscillator panels will be added dynamically -->
                </Grid.RowDefinitions>

                <!-- Main Price Chart with overlaid indicators -->
                <Grid Grid.Row="0">
                    <lvc:CartesianChart x:Name="PriceChart" 
                                       Series="{Binding PriceSeries}"
                                       DisableAnimations="False"
                                       AnimationsSpeed="0:0:0.5"
                                       DataTooltip="{Binding PriceChartTooltip}"
                                       Zoom="X"
                                       Hoverable="True"
                                       MouseMove="Chart_MouseMove">
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis x:Name="PriceChartXAxis" 
                                     Title="Date/Time" 
                                     Foreground="White"
                                     MinValue="0"
                                     LabelFormatter="{Binding DateTimeFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator StrokeThickness="1" Stroke="#30FFFFFF" Step="1" />
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis x:Name="PriceChartYAxis" 
                                     Title="Price" 
                                     Foreground="White">
                                <lvc:Axis.Separator>
                                    <lvc:Separator StrokeThickness="1" Stroke="#30FFFFFF" />
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>

                    <!-- Crosshair Overlay -->
                    <Canvas x:Name="PriceCrosshairCanvas" IsHitTestVisible="False"/>

                    <!-- Chart Controls -->
                    <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,5,0">
                        <Button x:Name="PriceChartSettingsButton" Content="⚙️" Width="42" Height="37" 
                                Style="{StaticResource EnhancedButtonStyle}" Margin="0,0,0,5" Click="ChartSettings_Click"/>
                        <Button x:Name="AddIndicatorButton" Content="+" Width="43" Height="36" 
                                Style="{StaticResource EnhancedButtonStyle}" Click="AddIndicator_Click"/>
                    </StackPanel>
                </Grid>

                <!-- Volume Chart -->
                <Grid Grid.Row="1">
                    <lvc:CartesianChart x:Name="VolumeChart" 
                                       DisableAnimations="False"
                                       AnimationsSpeed="0:0:0.5"
                                       Zoom="X"
                                       Hoverable="True"
                                       MouseMove="Chart_MouseMove">
                        <lvc:CartesianChart.Series>
                            <lvc:ColumnSeries x:Name="VolumeSeries" 
                                            Title="Volume" 
                                            Values="{Binding VolumeValues}"
                                            Fill="#5577FF"/>
                        </lvc:CartesianChart.Series>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis x:Name="VolumeChartXAxis" 
                                     ShowLabels="False"
                                     MinValue="0"
                                     LabelFormatter="{Binding DateTimeFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator StrokeThickness="1" Stroke="#30FFFFFF" Step="1" />
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis x:Name="VolumeChartYAxis" 
                                     Title="Volume" 
                                     Position="RightTop"
                                     Foreground="White">
                                <lvc:Axis.Separator>
                                    <lvc:Separator StrokeThickness="1" Stroke="#30FFFFFF" />
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>

                    <!-- Crosshair Overlay -->
                    <Canvas x:Name="VolumeCrosshairCanvas" IsHitTestVisible="False"/>

                    <!-- Chart Controls -->
                    <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,5,0">
                        <Button x:Name="VolumeChartSettingsButton" Content="⚙️" Width="38" Height="33" Style="{StaticResource EnhancedButtonStyle}" Click="ChartSettings_Click"/>
                        <Button x:Name="RemoveVolumeButton" Content="✕" Width="41" Height="33" 
                                Style="{StaticResource EnhancedButtonStyle}" Margin="0,5,0,0" Click="RemovePanel_Click"/>
                    </StackPanel>
                </Grid>

                <!-- Additional indicator panels will be added dynamically -->
            </Grid>
        </ScrollViewer>

        <!-- Bottom Panel - Indicator Selector -->
        <Grid Grid.Row="3" Background="#262639">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <ScrollViewer Grid.Column="0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <StackPanel x:Name="IndicatorButtonsPanel" Orientation="Horizontal" Margin="5">
                    <!-- Indicator toggle buttons will be added here -->
                    <Button Content="RSI" Tag="RSI" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="AddIndicatorPanel_Click"/>
                    <Button Content="MACD" Tag="MACD" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="AddIndicatorPanel_Click"/>
                    <Button Content="Bollinger Bands" Tag="BB" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="ToggleOverlayIndicator_Click"/>
                    <Button Content="VWAP" Tag="VWAP" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="ToggleOverlayIndicator_Click"/>
                    <Button Content="Moving Avg" Tag="MA" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="ToggleOverlayIndicator_Click"/>
                    <Button Content="StochRSI" Tag="STOCHRSI" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="AddIndicatorPanel_Click"/>
                    <Button Content="Williams %R" Tag="WILLIAMSR" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="AddIndicatorPanel_Click"/>
                    <Button Content="CCI" Tag="CCI" Style="{StaticResource EnhancedButtonStyle}" Margin="3" Click="AddIndicatorPanel_Click"/>
                </StackPanel>
            </ScrollViewer>

            <Button Grid.Column="1" Content="Customize Layout" Style="{StaticResource EnhancedButtonStyle}" Margin="10,5" Click="CustomizeLayout_Click"/>
        </Grid>

        <!-- Loading Overlay -->
        <Border x:Name="LoadingOverlay" Grid.RowSpan="4" 
                Background="#80000000" Visibility="Collapsed">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Loading Data..." Style="{StaticResource EnhancedTextBlockStyle}" Margin="0,0,0,10"/>
                <ProgressBar Width="150" Height="5" IsIndeterminate="True"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>