<UserControl x:Class="Quantra.Controls.StockExplorer"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
xmlns:local="clr-namespace:Quantra.Controls"
xmlns:converters="clr-namespace:Quantra.Converters"
xmlns:sys="clr-namespace:System;assembly=mscorlib"
Background="#23233A"
MinWidth="900" MinHeight="700">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:VwapColorConverter x:Key="VwapColorConverter"/>
        <converters:TimestampColorConverter x:Key="TimestampColorConverter"/>
        <converters:RsiColorConverter x:Key="RsiColorConverter"/>
        <converters:DayHighLowColorConverter x:Key="DayHighLowColorConverter"/>
        <converters:PercentChangeColorConverter x:Key="PercentChangeColorConverter"/>
        <converters:PredictionActionColorConverter x:Key="PredictionActionColorConverter"/>
        <converters:PredictionConfidenceColorConverter x:Key="PredictionConfidenceColorConverter"/>
        <converters:PredictedPriceColorConverter x:Key="PredictedPriceColorConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:PageNavigationConverter x:Key="PageNavigationConverter"/>
    </UserControl.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" MinHeight="50"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="Auto" MinWidth="200"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Symbol Selection Mode and Search -->
        <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Vertical" Margin="0,0,0,10">
            <!-- Mode Selection and Individual Asset Controls Row -->
            <Grid Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Mode Selection -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Mode:" 
                               VerticalAlignment="Center" 
                               Style="{StaticResource EnhancedTextBlockStyle}" 
                               Margin="0,0,10,0" 
                               FontWeight="Bold"/>
                    <ComboBox x:Name="SelectionModeComboBox"
                              Width="200"
                              Height="36"
                              SelectedIndex="0"
                              SelectionChanged="SelectionModeComboBox_SelectionChanged"
                              Style="{StaticResource EnhancedComboBoxStyle}">
                        <ComboBoxItem Content="Individual Asset"/>
                        <ComboBoxItem Content="Top Volume RSI Discrepancies"/>
                        <ComboBoxItem Content="Top P/E"/>
                        <ComboBoxItem Content="High Volume"/>
                        <ComboBoxItem Content="Low P/E"/>
                        <ComboBoxItem Content="RSI Oversold"/>
                        <ComboBoxItem Content="RSI Overbought"/>
                        <ComboBoxItem Content="All Database"/>
                        <ComboBoxItem Content="High Theta"/>
                        <ComboBoxItem Content="High Beta"/>
                        <ComboBoxItem Content="High Alpha"/>
                        <ComboBoxItem Content="Bullish Cup and Handle"/>
                        <ComboBoxItem Content="Bearish Cup and Handle"/>
                    </ComboBox>
                </StackPanel>

                <!-- Mode Action Buttons (in a separate column for better wrapping) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10,0,0,0">
                    <!-- RSI Oversold Button (visible only when RSI Oversold mode is selected) -->
                    <Button x:Name="RsiOversoldButton"
                            Content="Load RSI Oversold"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="RsiOversoldButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- RSI Overbought Button (visible only when RSI Overbought mode is selected) -->
                    <Button x:Name="RsiOverboughtButton"
                            Content="Load RSI Overbought"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="RsiOverboughtButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Top Volume RSI Button (visible only when Top Volume RSI Discrepancies mode is selected) -->
                    <Button x:Name="TopVolumeRsiButton"
                            Content="Load Top Volume RSI"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="TopVolumeRsiButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Top P/E Button (visible only when Top P/E mode is selected) -->
                    <Button x:Name="TopPEButton"
                            Content="Load Top P/E"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="TopPEButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- High Volume Button (visible only when High Volume mode is selected) -->
                    <Button x:Name="HighVolumeButton"
                            Content="Load High Volume"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="HighVolumeButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Low P/E Button (visible only when Low P/E mode is selected) -->
                    <Button x:Name="LowPEButton"
                            Content="Load Low P/E"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="LowPEButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- All Database Button (visible only when All Database mode is selected) -->
                    <Button x:Name="AllDatabaseButton"
                            Content="Load All Database"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="AllDatabaseButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- High Theta Button (visible only when High Theta mode is selected) -->
                    <Button x:Name="HighThetaButton"
                            Content="Load High Theta"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="HighThetaButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- High Beta Button (visible only when High Beta mode is selected) -->
                    <Button x:Name="HighBetaButton"
                            Content="Load High Beta"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="HighBetaButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- High Alpha Button (visible only when High Alpha mode is selected) -->
                    <Button x:Name="HighAlphaButton"
                            Content="Load High Alpha"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="HighAlphaButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Bullish Cup and Handle Button (visible only when Bullish Cup and Handle mode is selected) -->
                    <Button x:Name="BullishCupAndHandleButton"
                            Content="Load Cup and Handle"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="BullishCupAndHandleButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Bearish Cup and Handle Button (visible only when Bearish Cup and Handle mode is selected) -->
                    <Button x:Name="BearishCupAndHandleButton"
                            Content="Load Bearish Cup and Handle"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="BearishCupAndHandleButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Visibility="Collapsed"/>

                    <!-- Load All Historicals Button (always visible) -->
                    <Button x:Name="LoadAllHistoricalsButton"
                            Content="Load All Historicals"
                            Margin="0,0,5,0"
                            Padding="10,5"
                            Click="LoadAllHistoricalsButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            ToolTip="Load historical data for all stocks in the grid using TIME_SERIES_DAILY_ADJUSTED API"/>
                </StackPanel>

                <!-- Individual Asset Symbol Search Controls -->
                <StackPanel x:Name="SymbolSearchPanel" Grid.Column="2" Orientation="Horizontal" Margin="20,0,0,0">
                    <TextBlock Text="Symbol:" 
                               VerticalAlignment="Center" 
                               Style="{StaticResource EnhancedTextBlockStyle}" 
                               Margin="0,0,10,0" 
                               FontWeight="Bold"/>
                    <Grid Width="150" Height="36">
                        <TextBox x:Name="SymbolSearchTextBox"
                                    Height="36"
                                    VerticalContentAlignment="Center"
                                    Style="{StaticResource EnhancedTextBoxStyle}"
                                    TextChanged="SymbolSearchTextBox_TextChanged"
                                    PreviewKeyDown="SymbolSearchTextBox_PreviewKeyDown"
                                    GotFocus="SymbolSearchTextBox_GotFocus"
                                    LostFocus="SymbolSearchTextBox_LostFocus"/>
                        <Popup x:Name="SearchResultsPopup"
                                    PlacementTarget="{Binding ElementName=SymbolSearchTextBox}"
                                    Placement="Bottom"
                                    Width="350"
                                    MaxHeight="300"
                                    StaysOpen="False"
                                    AllowsTransparency="True">
                            <Border Background="#2D2D4D"
                                    BorderBrush="#3E3E56"
                                    BorderThickness="1"
                                    CornerRadius="3">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock x:Name="SearchLoadingText"
                                                 Grid.Row="0"
                                                 Text="Searching..."
                                                 Foreground="White"
                                                 FontStyle="Italic"
                                                 Margin="10,5"
                                                 Visibility="Collapsed"/>

                                    <ListBox x:Name="SearchResultsListBox"
                                                 Grid.Row="1"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 Foreground="White"
                                                 MouseLeftButtonUp="SearchResultsListBox_MouseLeftButtonUp"
                                                 PreviewKeyDown="SearchResultsListBox_PreviewKeyDown">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Vertical" Margin="5">
                                                    <TextBlock Text="{Binding Symbol}" FontWeight="Bold" Foreground="White"/>
                                                    <TextBlock Text="{Binding Name}" FontSize="10" Foreground="#AAAAAA"/>
                                                    <TextBlock Text="{Binding Region}" FontSize="9" Foreground="#888888"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Grid>
                            </Border>
                        </Popup>
                    </Grid>
                    <Button x:Name="RefreshButton" 
                            Content="Search" 
                            Margin="5,0,0,0"
                            Padding="8,5"
                            Height="36"
                            MinWidth="60"
                            Click="RefreshButton_Click"
                            Style="{StaticResource EnhancedButtonStyle}"
                            IsEnabled="False"/>
                </StackPanel>

                <!-- Symbol and Price Display (in the flexible space) -->
                <StackPanel Grid.Column="3" Orientation="Vertical" Margin="15,0,0,0" VerticalAlignment="Center" HorizontalAlignment="Left">
                    <TextBlock x:Name="SymbolLabel" 
                               Text="{Binding SymbolText, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                               Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                               FontWeight="Bold"/>
                    <TextBlock x:Name="PriceLabel" 
                               Text="{Binding PriceText, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                               Style="{StaticResource EnhancedSmallTextBlockStyle}"/>
                </StackPanel>
            </Grid>

            <!-- Mode Status Row -->
            <StackPanel x:Name="ModeStatusPanel" Orientation="Horizontal" Margin="0,5,0,0" Visibility="Collapsed">
                <TextBlock x:Name="ModeStatusText" 
                           Text="Loading..." 
                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                           FontStyle="Italic"/>
            </StackPanel>
        </StackPanel>



        <!-- Main Stock Chart and DataGrid -->
        <Grid Grid.Row="1" Grid.Column="0" Margin="0,0,10,0" Grid.ColumnSpan="3" Grid.RowSpan="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="3*"/>
                <RowDefinition Height="2*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- DataGrid for QuoteData -->
            <DataGrid x:Name="StockDataGrid"
                      x:FieldModifier="public"
                      ItemsSource="{Binding StockGridItems}"
                      SelectedItem="{Binding SelectedStock, Mode=TwoWay}"
                      SelectionChanged="StockDataGrid_SelectionChanged"
                      PreviewMouseRightButtonDown="StockDataGrid_PreviewMouseRightButtonDown"
                      MouseRightButtonUp="StockDataGrid_MouseRightButtonUp"
                      MouseDoubleClick="StockDataGrid_MouseDoubleClick"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      Grid.Row="0"
                      Grid.RowSpan="2"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      CanUserResizeColumns="True"
                      CanUserSortColumns="True"
                      Margin="5"
                      RowBackground="#23233A"
                      AlternatingRowBackground="#26264A"
                      GridLinesVisibility="None"
                      BorderBrush="#3E3E56"
                      BorderThickness="1"
                      Foreground="White"
                      Background="#23233A"
                      HorizontalScrollBarVisibility="Visible"
                      VerticalScrollBarVisibility="Auto"
                      HeadersVisibility="Column"
                      ColumnHeaderStyle="{StaticResource EnhancedDataGridColumnHeaderStyle}"
                      RowStyle="{StaticResource EnhancedDataGridRowStyle}"
                      CellStyle="{StaticResource EnhancedDataGridCellStyle}"
                      SizeChanged="StockDataGrid_SizeChanged"
                      ScrollViewer.ScrollChanged="StockDataGrid_ScrollChanged">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Symbol" Binding="{Binding Symbol}" Width="80">
                        <DataGridTextColumn.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="Symbol" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBox x:Name="SymbolFilterTextBox"
                                             Width="70"
                                             Height="25"
                                             Text="{Binding SymbolFilterText, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource EnhancedTextBoxStyle}"
                                             ToolTip="Filter stocks by symbol"
                                             VerticalContentAlignment="Center"
                                             Margin="0"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTextColumn.HeaderTemplate>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Price" Binding="{Binding Price, StringFormat={}{0:F2}}" Width="70"/>
                    <DataGridTextColumn Header="P/E Ratio" Binding="{Binding PERatio, StringFormat={}{0:F1}}" Width="70"/>
                    <DataGridTextColumn Header="VWAP" Binding="{Binding VWAP, StringFormat={}{0:F2}}" Width="70">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource VwapColorConverter}">
                                            <Binding Path="Price"/>
                                            <Binding Path="VWAP"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="RSI" Binding="{Binding RSI, StringFormat={}{0:F1}}" Width="60">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground" Value="{Binding RSI, Converter={StaticResource RsiColorConverter}}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Day High" Binding="{Binding DayHigh, StringFormat={}{0:F2}}" Width="70">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource DayHighLowColorConverter}" ConverterParameter="HIGH">
                                            <Binding Path="Price"/>
                                            <Binding Path="DayHigh"/>
                                            <Binding Path="DayLow"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Day Low" Binding="{Binding DayLow, StringFormat={}{0:F2}}" Width="70">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource DayHighLowColorConverter}" ConverterParameter="LOW">
                                            <Binding Path="Price"/>
                                            <Binding Path="DayHigh"/>
                                            <Binding Path="DayLow"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="% Change" Binding="{Binding ChangePercent, StringFormat={}{0:P2}}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground" Value="{Binding ChangePercent, Converter={StaticResource PercentChangeColorConverter}}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Volume" Binding="{Binding Volume, StringFormat={}{0:N0}}" Width="90">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="M.Cap" Binding="{Binding MarketCap, StringFormat={}{0:N0}}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <!-- Prediction Columns -->
                    <DataGridTextColumn Header="Pred. Price" Binding="{Binding PredictedPrice, StringFormat={}{0:F2}}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource PredictedPriceColorConverter}">
                                            <Binding Path="PredictedPrice"/>
                                            <Binding Path="Price"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Pred. Action" Binding="{Binding PredictedAction}" Width="90">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground" Value="{Binding PredictedAction, Converter={StaticResource PredictionActionColorConverter}}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Confidence" Binding="{Binding PredictionConfidence, StringFormat={}{0:P1}}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground" Value="{Binding PredictionConfidence, Converter={StaticResource PredictionConfidenceColorConverter}}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Updated Timestamp" Binding="{Binding CacheTime, StringFormat={}{0:MM/dd/yyyy HH:mm}}" Width="140">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource EnhancedDataGridColumnStyle}">
                                <Setter Property="Foreground" Value="{Binding CacheTime, Converter={StaticResource TimestampColorConverter}}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>
            </DataGrid>
            
            <!-- Pagination Control Panel -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="5,10,5,5">
                <!-- Previous Page Button -->
                <Button x:Name="PreviousPageButton"
                        Content="◀ Previous"
                        Padding="12,8"
                        Margin="0,0,10,0"
                        Style="{StaticResource EnhancedButtonStyle}"
                        Click="PreviousPageButton_Click"
                        IsEnabled="{Binding CurrentPage, Converter={StaticResource PageNavigationConverter}, ConverterParameter=Previous}"/>
                
                <!-- Page Info -->
                <TextBlock VerticalAlignment="Center"
                           Style="{StaticResource EnhancedTextBlockStyle}"
                           Margin="0,0,10,0">
                    <Run Text="Page "/>
                    <Run Text="{Binding CurrentPage, Mode=OneWay}" FontWeight="Bold"/>
                    <Run Text=" of "/>
                    <Run Text="{Binding TotalPages, Mode=OneWay}" FontWeight="Bold"/>
                    <Run Text=" ("/>
                    <Run Text="{Binding TotalCachedStocksCount, Mode=OneWay}"/>
                    <Run Text=" stocks)"/>
                </TextBlock>
                
                <!-- Next Page Button -->
                <Button x:Name="NextPageButton"
                        Content="Next ▶"
                        Padding="12,8"
                        Style="{StaticResource EnhancedButtonStyle}"
                        Click="NextPageButton_Click"
                        IsEnabled="{Binding HasMorePages}"/>
                
                <!-- Loading Indicator -->
                <TextBlock Text="Loading..." 
                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                           VerticalAlignment="Center"
                           Margin="15,0,0,0"
                           Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </Grid>
        <!-- Historical Data Chart and Indicator Panel -->
        <Grid Grid.Row="1" Grid.Column="3" Margin="0,0,0,0" Grid.RowSpan="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Symbol Label and Cache Timestamp with Refresh Button -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,5,0,2" VerticalAlignment="Bottom">
                <TextBlock Text="Symbol:" 
                           Style="{StaticResource EnhancedTextBlockStyle}" 
                           FontWeight="Bold"/>
                <TextBlock x:Name="SymbolDisplayLabel" 
                           Text="{Binding SelectedSymbolDisplay, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                           Style="{StaticResource EnhancedSmallTextBlockStyle}"
                           FontWeight="Bold"
                           Margin="10,0,0,0"/>
                <TextBlock Text="Cached:" 
                           Style="{StaticResource EnhancedTextBlockStyle}" 
                           Margin="20,0,0,0"/>
                <TextBlock x:Name="CacheTimestampLabel" 
                           Text="{Binding CacheTimestampText, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                           Style="{StaticResource EnhancedSmallTextBlockStyle}"
                           Foreground="{Binding CacheTimestampColor, RelativeSource={RelativeSource AncestorType=UserControl}}"
                           ToolTip="Date/time when this symbol's data was last cached"
                           Margin="5,0,0,0"/>
                <Button x:Name="RefreshSymbolDataButton"
                        Content="⟳ Refresh"
                        Margin="10,0,0,0"
                        Padding="8,2"
                        Height="24"
                        MinWidth="70"
                        Click="RefreshSymbolDataButton_Click"
                        Style="{StaticResource EnhancedButtonStyle}"
                        ToolTip="Fetch latest data from API for this symbol"
                        IsEnabled="{Binding CanRefreshSymbol, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
            </StackPanel>

            <!-- Static Indicators List -->
            <Border Grid.Row="1" 
                    Background="#2D2D4D" 
                    BorderBrush="#3E3E56" 
                    BorderThickness="1" 
                    CornerRadius="3" 
                    Margin="0,0,0,5">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" 
                              VerticalScrollBarVisibility="Disabled" 
                              Padding="10,5">
                    <StackPanel Orientation="Horizontal">
                        <!-- RSI Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Relative Strength Index (RSI)</Bold><LineBreak/>
                                        A momentum oscillator that measures the speed and magnitude of price changes.<LineBreak/>
                                        <Bold>Range:</Bold> 0-100<LineBreak/>
                                        <Bold>Overbought:</Bold> Above 70<LineBreak/>
                                        <Bold>Oversold:</Bold> Below 30<LineBreak/>
                                        <Bold>Use:</Bold> Identify potential reversal points
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="RSI" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding RsiValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- P/E Ratio Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Price-to-Earnings Ratio (P/E)</Bold><LineBreak/>
                                        A valuation metric comparing company's stock price to its earnings per share.<LineBreak/>
                                        <Bold>Calculation:</Bold> Stock Price ÷ Earnings Per Share<LineBreak/>
                                        <Bold>High P/E:</Bold> Growth expectations or overvaluation<LineBreak/>
                                        <Bold>Low P/E:</Bold> Value opportunity or poor prospects<LineBreak/>
                                        <Bold>Use:</Bold> Compare valuation relative to peers and history
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="P/E Ratio" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding PeRatioValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- MACD Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Moving Average Convergence Divergence (MACD)</Bold><LineBreak/>
                                        A trend-following momentum indicator that shows the relationship between two moving averages.<LineBreak/>
                                        <Bold>Calculation:</Bold> 12-period EMA minus 26-period EMA<LineBreak/>
                                        <Bold>Bullish:</Bold> MACD line above zero or signal line<LineBreak/>
                                        <Bold>Bearish:</Bold> MACD line below zero or signal line<LineBreak/>
                                        <Bold>Use:</Bold> Identify trend changes and momentum shifts
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="MACD" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding MacdValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- MACD Signal Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>MACD Signal Line</Bold><LineBreak/>
                                        A 9-period exponential moving average of the MACD line, used to generate buy/sell signals.<LineBreak/>
                                        <Bold>Calculation:</Bold> 9-period EMA of MACD line<LineBreak/>
                                        <Bold>Buy Signal:</Bold> MACD crosses above signal line<LineBreak/>
                                        <Bold>Sell Signal:</Bold> MACD crosses below signal line<LineBreak/>
                                        <Bold>Use:</Bold> Confirm MACD trend changes and timing entry/exit
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="MACD Signal" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding MacdSignalValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- MACD Histogram Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>MACD Histogram</Bold><LineBreak/>
                                        The difference between the MACD line and its signal line, showing momentum changes.<LineBreak/>
                                        <Bold>Calculation:</Bold> MACD Line - Signal Line<LineBreak/>
                                        <Bold>Positive:</Bold> MACD above signal (bullish momentum)<LineBreak/>
                                        <Bold>Negative:</Bold> MACD below signal (bearish momentum)<LineBreak/>
                                        <Bold>Use:</Bold> Early warning of MACD crossovers and momentum shifts
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="MACD Hist" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding MacdHistValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- VWAP Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Volume Weighted Average Price (VWAP)</Bold><LineBreak/>
                                        A trading benchmark that gives the average price weighted by volume.<LineBreak/>
                                        <Bold>Calculation:</Bold> Cumulative (Price × Volume) ÷ Cumulative Volume<LineBreak/>
                                        <Bold>Above VWAP:</Bold> Bullish bias, institutional buying<LineBreak/>
                                        <Bold>Below VWAP:</Bold> Bearish bias, institutional selling<LineBreak/>
                                        <Bold>Use:</Bold> Assess fair value and institutional sentiment
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="VWAP" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding VwapValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- ADX Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Average Directional Index (ADX)</Bold><LineBreak/>
                                        A non-directional indicator that measures the strength of a trend.<LineBreak/>
                                        <Bold>Range:</Bold> 0-100<LineBreak/>
                                        <Bold>Strong Trend:</Bold> Above 25<LineBreak/>
                                        <Bold>Weak Trend:</Bold> Below 20<LineBreak/>
                                        <Bold>Very Strong:</Bold> Above 50<LineBreak/>
                                        <Bold>Use:</Bold> Determine if a market is trending or ranging
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="ADX" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding AdxValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- CCI Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Commodity Channel Index (CCI)</Bold><LineBreak/>
                                        A versatile oscillator that identifies cyclical trends and overbought/oversold conditions.<LineBreak/>
                                        <Bold>Range:</Bold> Typically -100 to +100<LineBreak/>
                                        <Bold>Overbought:</Bold> Above +100<LineBreak/>
                                        <Bold>Oversold:</Bold> Below -100<LineBreak/>
                                        <Bold>Use:</Bold> Identify trend reversals and cyclical turning points
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="CCI" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding CciValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- ATR Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Average True Range (ATR)</Bold><LineBreak/>
                                        A volatility indicator that measures the average trading range over a period.<LineBreak/>
                                        <Bold>Calculation:</Bold> 14-period average of true range<LineBreak/>
                                        <Bold>High ATR:</Bold> High volatility, larger price moves<LineBreak/>
                                        <Bold>Low ATR:</Bold> Low volatility, smaller price moves<LineBreak/>
                                        <Bold>Use:</Bold> Set stop-losses, position sizing, and volatility assessment
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="ATR" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding AtrValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- MFI Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Money Flow Index (MFI)</Bold><LineBreak/>
                                        A volume-weighted version of RSI that incorporates both price and volume.<LineBreak/>
                                        <Bold>Range:</Bold> 0-100<LineBreak/>
                                        <Bold>Overbought:</Bold> Above 80<LineBreak/>
                                        <Bold>Oversold:</Bold> Below 20<LineBreak/>
                                        <Bold>Use:</Bold> Identify buying/selling pressure and potential reversals
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="MFI" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding MfiValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Stoch K Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Stochastic %K</Bold><LineBreak/>
                                        A momentum oscillator comparing the closing price to the trading range over a period.<LineBreak/>
                                        <Bold>Calculation:</Bold> (Close - Lowest Low) / (Highest High - Lowest Low) × 100<LineBreak/>
                                        <Bold>Range:</Bold> 0-100<LineBreak/>
                                        <Bold>Overbought:</Bold> Above 80<LineBreak/>
                                        <Bold>Oversold:</Bold> Below 20<LineBreak/>
                                        <Bold>Use:</Bold> Identify potential reversal points and momentum changes
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="Stoch K" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding StochKValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Stoch D Indicator -->
                        <Border Background="#23233A" 
                                BorderBrush="#3E3E56" 
                                BorderThickness="1" 
                                CornerRadius="3" 
                                Margin="0,0,10,0" 
                                Padding="8,4">
                            <Border.ToolTip>
                                <ToolTip Style="{StaticResource EnhancedToolTipStyle}">
                                    <TextBlock MaxWidth="300" TextWrapping="Wrap">
                                        <Bold>Stochastic %D</Bold><LineBreak/>
                                        A 3-period simple moving average of the %K line, providing smoother signals.<LineBreak/>
                                        <Bold>Calculation:</Bold> 3-period SMA of %K<LineBreak/>
                                        <Bold>Range:</Bold> 0-100<LineBreak/>
                                        <Bold>Buy Signal:</Bold> %K crosses above %D in oversold area<LineBreak/>
                                        <Bold>Sell Signal:</Bold> %K crosses below %D in overbought area<LineBreak/>
                                        <Bold>Use:</Bold> Confirm %K signals and reduce false signals
                                    </TextBlock>
                                </ToolTip>
                            </Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="Stoch D" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding StochDValue, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                           Style="{StaticResource EnhancedSmallTextBlockStyle}" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Indicator Selection Panel (horizontal, below chart) -->
            <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="0,5,0,0">
                <ItemsControl x:Name="IndicatorWrapPanel">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>
            <!-- Prediction Summary -->
            <TextBlock x:Name="PredictionSummaryText"
                       Grid.Row="3"
                       Text="{Binding DataContext.PredictionSummary, RelativeSource={RelativeSource AncestorType=UserControl}}"
                       Style="{StaticResource EnhancedTextBlockStyle}"
                       FontStyle="Italic"
                       Margin="0,5,0,0"/>

        </Grid>
    </Grid>
</UserControl>
