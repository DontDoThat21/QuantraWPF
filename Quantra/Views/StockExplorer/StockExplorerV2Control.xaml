<UserControl x:Class="Quantra.Controls.StockExplorerV2Control"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:converters="clr-namespace:Quantra.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="#1E1E30">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/EnhancedStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <converters:PercentChangeColorConverter x:Key="PercentChangeColorConverter"/>
            <converters:PredictionActionColorConverter x:Key="PredictionActionColorConverter"/>
            <converters:PredictionConfidenceColorConverter x:Key="PredictionConfidenceColorConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Title and Configuration -->
            <RowDefinition Height="Auto"/> <!-- Control Buttons -->
            <RowDefinition Height="2*"/>   <!-- Chart -->
            <RowDefinition Height="3*"/>   <!-- Data Grid -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Title and Configuration -->
        <Border Grid.Row="0" 
                Background="#2D2D42" 
                BorderBrush="#3E3E56" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15" 
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="📊 Stock Explorer V2" 
                               FontSize="20" 
                               FontWeight="Bold" 
                               Foreground="Cyan" 
                               VerticalAlignment="Center"
                               Margin="0,0,20,0"/>
                    
                    <Button x:Name="LoadConfigurationButton"
                            Content="Load Configuration"
                            Style="{StaticResource EnhancedButtonStyle}"
                            Click="LoadConfigurationButton_Click"
                            Padding="10,5"
                            Margin="0,0,10,0"/>
                    
                    <TextBlock x:Name="ConfigurationNameText"
                               Text="No configuration loaded"
                               Foreground="#888888"
                               VerticalAlignment="Center"
                               FontStyle="Italic"
                               Margin="10,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Update Interval:"
                               Foreground="White"
                               VerticalAlignment="Center"
                               Margin="0,0,10,0"/>
                    <ComboBox x:Name="UpdateIntervalComboBox"
                              Style="{StaticResource EnhancedComboBoxStyle}"
                              Width="120"
                              SelectionChanged="UpdateIntervalComboBox_SelectionChanged">
                        <ComboBoxItem Content="30 seconds" Tag="30" />
                        <ComboBoxItem Content="1 minute" Tag="60" IsSelected="True"/>
                        <ComboBoxItem Content="5 minutes" Tag="300"/>
                        <ComboBoxItem Content="10 minutes" Tag="600"/>
                        <ComboBoxItem Content="30 minutes" Tag="1800"/>
                    </ComboBox>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Control Buttons -->
        <Border Grid.Row="1" 
                Background="#2D2D42" 
                BorderBrush="#3E3E56" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15" 
                Margin="0,0,0,15">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="StartButton"
                        Content="▶ Start Updates"
                        Style="{StaticResource EnhancedButtonStyle}"
                        Click="StartButton_Click"
                        Padding="15,8"
                        Margin="0,0,10,0"/>
                
                <Button x:Name="StopButton"
                        Content="⏸ Stop Updates"
                        Style="{StaticResource EnhancedButtonStyle}"
                        Click="StopButton_Click"
                        Padding="15,8"
                        IsEnabled="False"
                        Margin="0,0,10,0"/>
                
                <Button x:Name="RefreshButton"
                        Content="🔄 Refresh Now"
                        Style="{StaticResource EnhancedButtonStyle}"
                        Click="RefreshButton_Click"
                        Padding="15,8"
                        Margin="0,0,10,0"/>
                
                <CheckBox x:Name="AutoAnalyzeCheckBox"
                          Content="Auto-analyze with ML"
                          Foreground="White"
                          VerticalAlignment="Center"
                          IsChecked="True"
                          Margin="20,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- Chart Area -->
        <Border Grid.Row="2" 
                Background="#2D2D42" 
                BorderBrush="#3E3E56" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15" 
                Margin="0,0,0,15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0"
                           Text="Price Overview"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="#1E90FF"
                           Margin="0,0,0,10"/>
                
                <lvc:CartesianChart Grid.Row="1"
                                    x:Name="PriceChart"
                                    Series="{Binding ChartSeries}"
                                    LegendLocation="Right"
                                    Hoverable="True"
                                    DataTooltip="{x:Null}">
                    <lvc:CartesianChart.AxisX>
                        <lvc:Axis Title="Symbol" 
                                  Labels="{Binding ChartLabels}"
                                  Foreground="White"
                                  FontSize="12">
                            <lvc:Axis.Separator>
                                <lvc:Separator StrokeThickness="0"/>
                            </lvc:Axis.Separator>
                        </lvc:Axis>
                    </lvc:CartesianChart.AxisX>
                    <lvc:CartesianChart.AxisY>
                        <lvc:Axis Title="Price ($)" 
                                  LabelFormatter="{Binding YFormatter}"
                                  Foreground="White"
                                  FontSize="12">
                            <lvc:Axis.Separator>
                                <lvc:Separator StrokeThickness="1" 
                                             Stroke="#3E3E56"/>
                            </lvc:Axis.Separator>
                        </lvc:Axis>
                    </lvc:CartesianChart.AxisY>
                </lvc:CartesianChart>
            </Grid>
        </Border>

        <!-- Data Grid -->
        <Border Grid.Row="3" 
                Background="#2D2D42" 
                BorderBrush="#3E3E56" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0"
                           Text="Stock Analysis Data"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="#1E90FF"
                           Margin="0,0,0,10"/>
                
                <DataGrid Grid.Row="1"
                          x:Name="StockDataGrid"
                          ItemsSource="{Binding StockAnalysisData}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          IsReadOnly="True"
                          Background="#23233A"
                          Foreground="White"
                          GridLinesVisibility="Horizontal"
                          HorizontalGridLinesBrush="#3E3E56"
                          HeadersVisibility="Column"
                          RowBackground="#2D2D42"
                          AlternatingRowBackground="#262638"
                          BorderThickness="0"
                          SelectionMode="Single"
                          SelectionUnit="FullRow">
                    
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="Background" Value="#3E3E56"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Setter Property="Padding" Value="10,5"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGrid.ColumnHeaderStyle>
                    
                    <DataGrid.CellStyle>
                        <Style TargetType="DataGridCell">
                            <Setter Property="Padding" Value="5"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                        </Style>
                    </DataGrid.CellStyle>
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Symbol" Binding="{Binding Symbol}" Width="80"/>
                        <DataGridTextColumn Header="Price" Binding="{Binding CurrentPrice, StringFormat={}{0:C2}}" Width="80"/>
                        <DataGridTextColumn Header="Change %" Width="90">
                            <DataGridTextColumn.Binding>
                                <Binding Path="PercentChange" StringFormat="{}{0:F2}%"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{Binding PercentChange, Converter={StaticResource PercentChangeColorConverter}}"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="RSI" Binding="{Binding RSI, StringFormat={}{0:F2}}" Width="60"/>
                        <DataGridTextColumn Header="MACD" Binding="{Binding MACD, StringFormat={}{0:F2}}" Width="70"/>
                        <DataGridTextColumn Header="VWAP" Binding="{Binding VWAP, StringFormat={}{0:C2}}" Width="80"/>
                        <DataGridTextColumn Header="Volume" Binding="{Binding Volume, StringFormat={}{0:N0}}" Width="100"/>
                        <DataGridTextColumn Header="Prediction" Binding="{Binding PredictedAction}" Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{Binding PredictedAction, Converter={StaticResource PredictionActionColorConverter}}"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Confidence" Width="95">
                            <DataGridTextColumn.Binding>
                                <Binding Path="Confidence" StringFormat="{}{0:P0}"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{Binding Confidence, Converter={StaticResource PredictionConfidenceColorConverter}}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Target Price" Binding="{Binding TargetPrice, StringFormat={}{0:C2}}" Width="100"/>
                        <DataGridTextColumn Header="Last Updated" Binding="{Binding LastUpdated, StringFormat={}{0:HH:mm:ss}}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="4" 
                Background="#262638" 
                BorderBrush="#3E3E56" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="10" 
                Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock x:Name="StatusText"
                           Grid.Column="0"
                           Text="Ready - Load a configuration to begin"
                           Foreground="#888888"
                           VerticalAlignment="Center"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock x:Name="SymbolCountText"
                               Text="Symbols: 0"
                               Foreground="#1E90FF"
                               VerticalAlignment="Center"
                               Margin="0,0,15,0"/>
                    <TextBlock x:Name="LastUpdateText"
                               Text="Last update: Never"
                               Foreground="#888888"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
